/*

    {{ warn }}

    Domain: {{ domain.name }}
{% if 'desc' in domain %}
    Description: {{ domain.desc }}
{% endif %}
*/

#pragma once

#include <iostream>
#include <string>
#include <vector>
#include <optional>
#include <chrono>
#include <sstream>
#include <iomanip>

namespace loglab_{{ domain.name }}
{
    class LogSerializer {
    public:
        static thread_local std::stringstream ss;
        static thread_local std::string buffer;
        
        static std::string& SerializeToBuffer(const std::string& content) {
            ss.clear();
            ss.str("");
            ss << content;
            buffer = ss.str();
            return buffer;
        }
    };
    
    // Thread-local static member definitions
    thread_local std::stringstream LogSerializer::ss;
    thread_local std::string LogSerializer::buffer;

{% for name, elst in events.items() %}
{% set edata = elst[-1] %}
{% set edef = edata[1] %}
    /// <summary>
    ///  {{ edef.desc }}
    /// </summary>
    class {{ name }}
    {
    public:
        static constexpr const char* Event = "{{ name }}";

        // Required fields
{% for fname, flst in (edef.fields|required).items() %}
{% set fdata = flst[-1] %}
{% set fdef = fdata[1] %}
        // {{ fdef.desc }}
        {{ type(fdef) }} {{ fname }};
{% endfor %}

        // Optional fields
{% for fname, flst in (edef.fields|optional).items() %}
{% set fdata = flst[-1] %}
{% set fdef = fdata[1] %}
        // {{ fdef.desc }}
        std::optional<{{ type(fdef) }}> {{ fname }};
{% endfor %}

        {{ name }}() {}

        {{ name }}({% for fname, flst in (edef.fields|required).items() %}{% set fdata = flst[-1] %}{% set fdef = fdata[1] %}{{ type(fdef) }} _{{ fname }}{% if not loop.last %}, {% endif %}{% endfor %})
        {
            reset({% for fname, flst in (edef.fields|required).items() %}_{{ fname }}{% if not loop.last %}, {% endif %}{% endfor %});
        }

        void reset({% for fname, flst in (edef.fields|required).items() %}{% set fdata = flst[-1] %}{% set fdef = fdata[1] %}{{ type(fdef) }} _{{ fname }}{% if not loop.last %}, {% endif %}{% endfor %})
        {
{% for fname, flst in (edef.fields|required).items() %}
            {{ fname }} = _{{ fname }};
{% endfor %}
{% for fname, flst in (edef.fields|optional).items() %}
            {{ fname }}.reset();
{% endfor %}
        }

        std::string& serialize()
        {
            LogSerializer::ss.clear();
            LogSerializer::ss.str("");
            LogSerializer::ss << "{";

            // DateTime and Event
            auto now = std::chrono::system_clock::now();
            auto in_time_t = std::chrono::system_clock::to_time_t(now);
            LogSerializer::ss << "\"DateTime\":\"" << std::put_time(std::gmtime(&in_time_t), "%Y-%m-%dT%H:%M:%SZ") << "\",";
            LogSerializer::ss << "\"Event\":\"" << Event << "\"";

            // Required fields
{% for fname, flst in (edef.fields|required).items() %}
{% set fdef = flst[-1][1] %}
            LogSerializer::ss << ",";
            LogSerializer::ss << "\"{{ fname }}\":";
{% if type(fdef) == 'std::string' %}
            LogSerializer::ss << "\"" << {{ fname }} << "\"";
{% elif type(fdef) == 'bool' %}
            LogSerializer::ss << ({{ fname }} ? "true" : "false");
{% else %}
            LogSerializer::ss << {{ fname }};
{% endif %}
{% endfor %}

            // Optional fields
{% for fname, flst in (edef.fields|optional).items() %}
{% set fdef = flst[-1][1] %}
            if ({{ fname }}.has_value())
            {
                LogSerializer::ss << ",";
                LogSerializer::ss << "\"{{ fname }}\":";
{% if type(fdef) == 'std::string' %}
                LogSerializer::ss << "\"" << {{ fname }}.value() << "\"";
{% elif type(fdef) == 'bool' %}
                LogSerializer::ss << ({{ fname }}.value() ? "true" : "false");
{% else %}
                LogSerializer::ss << {{ fname }}.value();
{% endif %}
            }
{% endfor %}

            LogSerializer::ss << "}";
            LogSerializer::buffer = LogSerializer::ss.str();
            return LogSerializer::buffer;
        }
    };
{% endfor %}
}